<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Architect</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<<<<<<< HEAD
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        /* CSS remains the same as the last version... */
=======
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
>>>>>>> c910d19acb069497d001c64720779e55eb21a051
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #2a9d8f;
            --primary-hover: #264653;
            --text-color: #e0e0e0;
            --subtle-text: #888;
            --border-color: #333;
            --success-color: #2a9d8f;
            --danger-color: #e76f51;
            --glow-color: rgba(42, 157, 143, 0.1);
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 40px 40px;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        
        .app-header {
            max-width: 1160px;
            margin: 0 auto 20px auto;
            padding: 10px 20px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .app-logo {
            height: 60px;
            width: auto;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        @media (max-width: 900px) { .app-container { grid-template-columns: 1fr; } }

        .main-content, .sidebar {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px var(--glow-color);
        }

        h2, h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-weight: 600;
        }

        .progression-display {
            background-color: var(--bg-color);
            min-height: 60px;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        
        .progression-diagrams {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start;
            align-items: center; min-height: 120px; margin-bottom: 20px; padding: 10px;
            background-color: var(--bg-color); border-radius: 6px; border: 1px solid var(--border-color);
        }
        .progression-diagrams svg {
            width: 100px; height: 120px; background-color: var(--surface-color);
            border-radius: 6px; border: 1px solid var(--border-color);
        }
        
        .progression-placeholder { color: var(--subtle-text); font-style: italic; }

        .chord-pill {
            background-color: var(--primary-color); color: white; padding: 8px 15px;
            border-radius: 20px; font-weight: 500; font-size: 1em; display: flex;
            align-items: center; gap: 8px; cursor: pointer; transition: all 0.2s;
        }
        .chord-pill:hover { background-color: var(--primary-hover); transform: translateY(-2px); }
        .chord-name { flex-grow: 1; }
        .remove-chord {
            background-color: rgba(255, 255, 255, 0.1); border-radius: 50%; width: 20px; height: 20px;
            display: flex; justify-content: center; align-items: center; font-size: 14px;
            font-weight: bold; line-height: 1; flex-shrink: 0; border: none; color: white;
            padding: 0; cursor: pointer; transition: background-color 0.2s;
        }
<<<<<<< HEAD
        .remove-chord:hover { background-color: rgba(0, 0, 0, 0.4); }

        .controls-container {
            margin-bottom: 20px;
        }
        .controls { 
            display: flex; 
            gap: 10px; 
        }
        .controls-info {
            color: var(--subtle-text);
            font-size: 1em;
            margin: 8px 0 0 5px;
            font-style: italic;
        }
=======
        .remove-chord:hover { background-color: rgba(255, 255, 255, 0.2); }
>>>>>>> c910d19acb069497d001c64720779e55eb21a051

        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { 
            padding: 8px 12px; border: none; border-radius: 5px; font-size: 1em; cursor: pointer;
            transition: all 0.2s; font-family: 'Poppins', sans-serif;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-save { background-color: var(--success-color); color: white; }
        .btn-save:hover { background-color: #264653; }
        .btn-clear { background-color: var(--danger-color); color: white; }
        .btn-clear:hover { background-color: #f4a261; }
        #add-chord-btn {
            background-color: #6c757d;
            color: white;
        }
        #add-chord-btn:hover {
             background-color: #5a6268;
        }
        .key-selector-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        #key-selector, .modal-key-selector { padding: 8px; border-radius: 5px; background-color: #333; color: white; border: 1px solid var(--border-color); font-family: 'Poppins', sans-serif;}

        .chord-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        .chord-btn {
            background-color: #2f2f2f; color: var(--text-color); padding: 12px 0; text-align: center; border-radius: 5px;
            cursor: pointer; transition: all 0.2s; font-weight: 500; border: 1px solid var(--border-color); font-size: 1em;
        }
        .chord-btn:hover { background-color: #444; transform: translateY(-2px); }

        .saved-progressions-list { list-style: none; padding: 0; margin: 0; }
        .saved-item { background-color: #282828; padding: 10px 15px; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .saved-chords { font-family: monospace; font-size: 1.1em; }
        .saved-item-actions button { background: none; border: none; color: #888; cursor: pointer; font-size: 1.2em; margin-left: 10px; transition: color 0.2s; }
        .saved-item-actions button:hover { color: var(--primary-color); }

        .scale-selector { display: flex; flex-direction: column; gap: 10px; }
        .scale-btn {
            background-color: #2f2f2f; color: var(--text-color); padding: 12px; text-align: left;
            border-radius: 5px; cursor: pointer; transition: all 0.2s;
            border: 1px solid var(--border-color); font-family: 'Poppins', sans-serif;
        }
        .scale-btn:hover { background-color: #444; transform: translateY(-2px); }
        
        .box-selector { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .box-btn {
            background-color: #444; border: 1px solid var(--border-color); color: var(--text-color);
            padding: 6px 12px; border-radius: 5px; cursor: pointer; transition: all 0.2s;
        }
        .box-btn.active, .box-btn:hover { background-color: var(--primary-color); border-color: var(--primary-hover); transform: translateY(-1px); }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0, 0, 0, 0.4); animation: fadeIn 0.3s;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 10% auto; padding: 20px; border-radius: 12px; width: 80%; max-width: 320px;
            text-align: center; position: relative; animation: slideIn 0.3s;
        }
        #add-chord-modal .modal-content { max-width: 450px; text-align: left; }
        .modal-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input {
            width: 95%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color);
            background-color: var(--bg-color); color: var(--text-color); font-family: 'Poppins', sans-serif;
        }
        .form-group p.info {
            font-size: 0.9em;
            color: var(--subtle-text);
            margin: 5px 0 0 0;
            padding-left: 10px;
            border-left: 2px solid var(--border-color);
        }
        .close-button {
            color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px;
            font-weight: bold; cursor: pointer; transition: color 0.2s;
        }
        .close-button:hover, .close-button:focus { color: white; }
        #modal-chord-diagram { margin-top: 15px; }
        #modal-chord-diagram > img, #modal-chord-diagram > svg { margin: 0 auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <header class="app-header">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Chord Architect Logo" class="app-logo">
    </header>
    <div class="app-container">
        <main class="main-content">
            <h2>Current Progression</h2>
            <div id="progression-display" class="progression-display">
                <span class="progression-placeholder">Select chords from the right...</span>
            </div>
            <div id="progression-diagrams" class="progression-diagrams"></div>
            <div class="controls">
                <button id="save-btn" class="btn btn-save">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Save
                </button>
                <button id="clear-btn" class="btn btn-clear">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Clear
                </button>
            </div>
            <hr>
            <h2>Saved Progressions</h2>
            <ul id="saved-progressions-list" class="saved-progressions-list"></ul>
        </main>
        <aside class="sidebar">
            <h3>Chord Selector</h3>
            <div class="key-selector-container">
                <label for="key-selector">View Chords:</label>
                <select id="key-selector"></select>
                <button id="add-chord-btn" class="btn" style="margin-left: auto;">
                     ➕ New
                </button>
            </div>
            <div id="chord-selector" class="chord-selector"></div>
            <hr>
            <h3>Scales</h3>
            <div id="scale-selector" class="scale-selector"></div>
        </aside>
    </div>
    
    <div id="chord-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-button">&times;</span>
            <h2 id="modal-chord-title"></h2>
            <div class="modal-controls">
                 <div id="modal-box-selector" class="box-selector"></div>
                 <select id="modal-key-selector" class="modal-key-selector" style="display: none;"></select>
            </div>
            <div id="modal-chord-diagram"></div>
        </div>
    </div>
    
    <div id="add-chord-modal" class="modal">
        <div class="modal-content">
            <span id="close-add-modal-btn" class="close-button">&times;</span>
            <h2>Add New Chord</h2>
            <form id="add-chord-form">
                <div class="form-group">
                    <label for="new-chord-name">Chord Name (e.g., "Gsus4")</label>
                    <input type="text" id="new-chord-name" required>
                </div>
                <div class="form-group">
                    <label for="new-chord-title">Display Title (e.g., "G suspended 4th")</label>
                    <input type="text" id="new-chord-title" required>
                </div>
                <div class="form-group">
<<<<<<< HEAD
                    <label for="starting-fret">Starting Fret (Position)</label>
                    <input type="number" id="starting-fret" value="0" min="0" max="12">
                </div>
                <div class="form-group">
                    <label>Fret Shape (relative to start)</label>
=======
                    <label>Fret Positions (E-A-D-G-B-e)</label>
                    <p class="info">Enter the actual fret numbers. For open chords, use 0. For chords higher up the neck, use the real fret number (e.g., 5, 7, etc.). The diagram position will be calculated automatically.</p>
>>>>>>> c910d19acb069497d001c64720779e55eb21a051
                    <div style="display: flex; gap: 5px;">
                        <input type="number" class="fret-input" required value="-1" style="width: 15%;">
                        <input type="number" class="fret-input" required value="0" style="width: 15%;">
                        <input type="number" class="fret-input" required value="0" style="width: 15%;">
                        <input type="number" class="fret-input" required value="0" style="width: 15%;">
                        <input type="number" class="fret-input" required value="0" style="width: 15%;">
                        <input type="number" class="fret-input" required value="0" style="width: 15%;">
                    </div>
                </div>
                 <div class="form-group">
                    <label><input type="checkbox" id="has-barre"> Has Barre?</label>
                </div>
                <div id="barre-details" style="display: none; border-left: 2px solid var(--primary-color); padding-left: 15px;">
                    <div class="form-group"><label for="barre-fret">Barre Fret (relative to start):</label><input type="number" id="barre-fret" min="1"></div>
                    <div class="form-group"><label for="barre-from">From String (e.g., 6):</label><input type="number" id="barre-from" min="1" max="6"></div>
                    <div class="form-group"><label for="barre-to">To String (e.g., 1):</label><input type="number" id="barre-to" min="1" max="6"></div>
                </div>
                <button type="submit" class="btn btn-save" style="width: 100%;">💾 Save Chord</button>
                <p id="add-chord-error" style="color: var(--danger-color); text-align: center;"></p>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const DIATONIC_CHORDS = { 'C': ['C', 'Dm', 'Em', 'F', 'G', 'Am'], 'G': ['G', 'Am', 'Bm', 'C', 'D', 'Em'], 'D': ['D', 'Em', 'F#m', 'G', 'A', 'Bm'], 'A': ['A', 'Bm', 'C#m', 'D', 'E', 'F#m'], 'E': ['E', 'F#m', 'G#m', 'A', 'B', 'C#m'], 'B': ['B', 'C#m', 'D#m', 'E', 'F#', 'G#m'], 'F#': ['F#', 'G#m', 'A#m', 'B', 'C#', 'D#m'], 'C#': ['C#', 'D#m', 'E#m', 'F#', 'G#', 'A#m'], 'F': ['F', 'Gm', 'Am', 'Bb', 'C', 'Dm'], 'Bb': ['Bb', 'Cm', 'Dm', 'Eb', 'F', 'Gm'], 'Eb': ['Eb', 'Fm', 'Gm', 'Ab', 'Bb', 'Cm'], 'Ab': ['Ab', 'Bbm', 'Cm', 'Db', 'Eb', 'Fm'] };
            const ALL_KEYS = ["E", "F", "F#", "G", "G#", "A", "A#", "B", "C", "C#", "D", "D#"];
            let currentProgression = [], savedProgressions = JSON.parse(localStorage.getItem('savedProgressions')) || [], allChordsData = {}, allScalesData = {};
            
            const chordSelector = document.getElementById('chord-selector'), progressionDisplay = document.getElementById('progression-display'),
                  progressionDiagrams = document.getElementById('progression-diagrams'), 
                  saveBtn = document.getElementById('save-btn'), clearBtn = document.getElementById('clear-btn'),
                  savedList = document.getElementById('saved-progressions-list'), keySelector = document.getElementById('key-selector'),
                  addChordBtn = document.getElementById('add-chord-btn'), chordModal = document.getElementById('chord-modal'),
                  closeModalBtn = document.getElementById('close-modal-btn'), modalTitle = document.getElementById('modal-chord-title'),
                  modalDiagram = document.getElementById('modal-chord-diagram'), 
                  addChordModal = document.getElementById('add-chord-modal'), closeAddModalBtn = document.getElementById('close-add-modal-btn'),
                  addChordForm = document.getElementById('add-chord-form'), addChordError = document.getElementById('add-chord-error'),
                  scaleSelector = document.getElementById('scale-selector'), modalKeySelector = document.getElementById('modal-key-selector');
            
            const renderChordButtons = () => {
                const selectedKey = keySelector.value;
                const chordsToShow = selectedKey === 'all' ? Object.keys(allChordsData) : DIATONIC_CHORDS[selectedKey];
                
                chordSelector.innerHTML = '';
                if (chordsToShow) {
                    chordsToShow.forEach(name => {
                        if (allChordsData[name]) {
                            const btn = document.createElement('button');
                            btn.className = 'chord-btn';
                            btn.textContent = name;
                            btn.dataset.chord = name;
                            chordSelector.appendChild(btn);
                        }
                    });
                }
            };
            
            const renderKeySelector = () => {
                keySelector.innerHTML = '';
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All Chords';
                keySelector.appendChild(allOption);

                Object.keys(DIATONIC_CHORDS).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = `Key of ${key}`;
                    keySelector.appendChild(opt);
                });
            };

            const renderScaleButtons = () => { scaleSelector.innerHTML = ''; for (const key in allScalesData) { const scale = allScalesData[key]; const btn = document.createElement('button'); btn.className = 'scale-btn'; btn.textContent = scale.title; btn.dataset.scale = key; scaleSelector.appendChild(btn); } };
            const renderProgression = async () => {
                progressionDisplay.innerHTML = '';
                if (currentProgression.length === 0) {
                    progressionDisplay.innerHTML = '<span class="progression-placeholder">Select chords...</span>';
                    progressionDiagrams.innerHTML = '';
                    return;
                }
                currentProgression.forEach((chord, i) => {
                    const pill = document.createElement('div');
                    pill.className = 'chord-pill';
                    pill.dataset.chordName = chord;
                    pill.innerHTML = `<span class="chord-name">${chord}</span><button class="remove-chord" data-index="${i}">&times;</button>`;
                    progressionDisplay.appendChild(pill);
                });
                progressionDiagrams.innerHTML = '<span class="progression-placeholder">Loading...</span>';
                const diagramPromises = currentProgression.map(chordName => {
                    const formData = new FormData();
                    formData.append('chord', chordName);
                    return fetch('/api/chord-diagram', { method: 'POST', body: formData }).then(res => res.ok ? res.text() : '');
                });
                progressionDiagrams.innerHTML = (await Promise.all(diagramPromises)).join('');
            };
            const renderSavedProgressions = () => { savedList.innerHTML = ''; if (savedProgressions.length === 0) { savedList.innerHTML = '<li>No saved progressions.</li>'; return; } savedProgressions.forEach((prog, i) => { const item = document.createElement('li'); item.className = 'saved-item'; item.innerHTML = `<span class="saved-chords">${prog.join(' - ')}</span><div><button data-action="load" data-index="${i}">⬆️</button><button data-action="delete" data-index="${i}">🗑️</button></div>`; savedList.appendChild(item); }); };
            const addChordToProgression = (chord) => { currentProgression.push(chord); renderProgression(); };
            const removeChordFromProgression = (index) => { currentProgression.splice(index, 1); renderProgression(); };
            const saveCurrentProgression = () => { if (currentProgression.length > 0) { savedProgressions.push([...currentProgression]); localStorage.setItem('savedProgressions', JSON.stringify(savedProgressions)); renderSavedProgressions(); } };
            const handleSavedListClick = (e) => { const target = e.target.closest('button'); if (!target) return; const index = parseInt(target.dataset.index); if (target.dataset.action === 'load') { currentProgression = [...savedProgressions[index]]; renderProgression(); } else if (target.dataset.action === 'delete') { savedProgressions.splice(index, 1); localStorage.setItem('savedProgressions', JSON.stringify(savedProgressions)); renderSavedProgressions(); } };
            const openChordModal = async (chordName) => { document.getElementById('modal-box-selector').innerHTML = ''; modalKeySelector.style.display = 'none'; modalTitle.textContent = allChordsData[chordName]?.title || chordName; modalDiagram.innerHTML = 'Loading...'; chordModal.style.display = 'block'; try { const formData = new FormData(); formData.append('chord', chordName); const response = await fetch('/api/chord-diagram', { method: 'POST', body: formData }); if (!response.ok) throw new Error(await response.text()); modalDiagram.innerHTML = await response.text(); } catch (error) { modalDiagram.innerHTML = `<p style="color: var(--danger-color);">Could not load diagram. ${error.message}</p>`; } };
            const openScaleModal = async (scaleName, key = 'E', box = 'box1') => { const definition = allScalesData[scaleName]; modalTitle.textContent = definition ? `${key} ${definition.title} - Box ${box.slice(-1)}` : `${key} ${scaleName}`; modalDiagram.innerHTML = 'Loading...'; chordModal.style.display = 'block'; const boxSelector = document.getElementById('modal-box-selector'); boxSelector.innerHTML = ''; if (definition?.pattern) { Object.keys(definition.pattern).forEach(boxKey => { const button = document.createElement('button'); button.className = `box-btn ${boxKey === box ? 'active' : ''}`; button.textContent = `Box ${boxKey.slice(-1)}`; button.onclick = () => openScaleModal(scaleName, key, boxKey); boxSelector.appendChild(button); }); } modalKeySelector.style.display = 'inline-block'; modalKeySelector.innerHTML = ''; ALL_KEYS.forEach(k => { const option = document.createElement('option'); option.value = k; option.textContent = k; if (k === key) option.selected = true; modalKeySelector.appendChild(option); }); modalKeySelector.onchange = (e) => openScaleModal(scaleName, e.target.value, box); try { const formData = new FormData(); formData.append('scale', scaleName); formData.append('key', key); formData.append('box', box); const response = await fetch('/api/scale-diagram', { method: 'POST', body: formData }); if (!response.ok) throw new Error(await response.text()); modalDiagram.innerHTML = await response.text(); } catch (error) { modalDiagram.innerHTML = `<p style="color: var(--danger-color);">Could not load diagram. ${error.message}</p>`; } };
            const closeModal = () => { chordModal.style.display = 'none'; };
            const initializeApp = async () => {
                try {
                    const [chordsResponse, scalesResponse] = await Promise.all([fetch('/api/chords'), fetch('/api/scales')]);
                    if (!chordsResponse.ok) throw new Error('Failed to load chords.');
                    if (!scalesResponse.ok) throw new Error('Failed to load scales.');
                    allChordsData = await chordsResponse.json();
                    allScalesData = await scalesResponse.json();
                    renderKeySelector();
                    renderChordButtons();
                    renderScaleButtons();
                    renderProgression();
                    renderSavedProgressions();
                } catch (error) {
                    console.error("Initialization failed:", error);
                    chordSelector.innerHTML = `<p style="color: var(--danger-color);">Could not load app data.</p>`;
                }
            };
            
            keySelector.addEventListener('change', renderChordButtons);
            
            chordSelector.addEventListener('click', e => e.target.classList.contains('chord-btn') && addChordToProgression(e.target.dataset.chord));
            scaleSelector.addEventListener('click', e => e.target.classList.contains('scale-btn') && openScaleModal(e.target.dataset.scale));
            progressionDisplay.addEventListener('click', e => { const pill = e.target.closest('.chord-pill'); if (e.target.classList.contains('remove-chord')) removeChordFromProgression(parseInt(e.target.dataset.index)); else if (pill) openChordModal(pill.dataset.chordName); });
            saveBtn.addEventListener('click', saveCurrentProgression);
            clearBtn.addEventListener('click', () => { currentProgression = []; renderProgression(); });
            savedList.addEventListener('click', handleSavedListClick);
            closeModalBtn.addEventListener('click', closeModal);
            window.addEventListener('click', e => e.target == chordModal && closeModal());
            
            const addChordModalEl = document.getElementById('add-chord-modal');
            addChordBtn.addEventListener('click', () => { addChordForm.reset(); addChordError.textContent = ''; document.getElementById('barre-details').style.display = 'none'; addChordModalEl.style.display = 'block'; });
            document.getElementById('close-add-modal-btn').addEventListener('click', () => addChordModalEl.style.display = 'none');
            document.getElementById('has-barre').addEventListener('change', e => { document.getElementById('barre-details').style.display = e.target.checked ? 'block' : 'none'; });

            // --- MODIFIED: Form submission logic now calculates absolute frets ---
            addChordForm.addEventListener('submit', async e => {
                e.preventDefault();
                addChordError.textContent = '';

                const position = parseInt(document.getElementById('starting-fret').value, 10) || 0;
                
                const relativeFrets = Array.from(document.querySelectorAll('.fret-input')).map(input => parseInt(input.value, 10));
                
                const absoluteFrets = relativeFrets.map(fret => {
                    if (fret <= 0) return fret; // Keep muted (-1) and open (0) strings as they are
                    return position + fret - 1; // E.g., position 5, relative fret 1 becomes absolute fret 5
                });
                
                const barres = [];
                if (document.getElementById('has-barre').checked) {
                    const relativeBarreFret = parseInt(document.getElementById('barre-fret').value, 10);
                    barres.push({
                        fret: position + relativeBarreFret - 1,
                        fromString: parseInt(document.getElementById('barre-from').value, 10),
                        toString: parseInt(document.getElementById('barre-to').value, 10)
                    });
                }

                const payload = {
                    name: document.getElementById('new-chord-name').value,
                    title: document.getElementById('new-chord-title').value,
                    frets: absoluteFrets,
                    barres: barres
                };

                try {
                    const response = await fetch('/api/chords', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(await response.text());
                    addChordModalEl.style.display = 'none';
                    await initializeApp();
                } catch (error) {
                    addChordError.textContent = `Error: ${error.message}`;
                }
            });

            initializeApp();
        });
    </script>
</body>
</html>
